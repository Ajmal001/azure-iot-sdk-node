name: $(BuildID)_$(BuildDefinitionName)_$(SourceBranchName)_$(Date:yyyyMMdd)$(Rev:.r)
resources:
- repo: self
  clean: true
phases:
- phase: Phase_2
  displayName: Ubuntu 1604 - Node 10.15.x

  condition: succeededOrFailed()
  queue:
    name: Hosted Ubuntu 1604
  steps:
  - task: NodeTool@0
    displayName: 'Use Node 10.15.x'
    inputs:
      versionSpec: '10.15.x'
  - script: |
      npm install --global node-gyp
      npm install --global lerna
      npm install
    displayName: 'Install Dependencies'
  - script: |
      lerna bootstrap --hoist
      lerna run build
    displayName: 'Bootstrap & Build'
  - script: |
      cd digitaltwins/service
      npm -s run ci
    displayName: 'Unit Tests: Service'
  - script: |
      cd digitaltwins/model_repository
      npm -s run ci
    displayName: 'Unit Tests: Model Repository'
  - script: |
      cd digitaltwins/device
      npm -s run ci
    displayName: 'Unit Tests: Device'
  - script: |
      cd digitaltwins/samples/service
      npm -s run lint
    displayName: 'Linter: Service Samples'
  - script: |
      cd digitaltwins/samples/model_repository
      npm -s run lint
    displayName: 'Linter: Model Repo Samples'
  - script: |
      cd digitaltwins/samples/device/typescript
      npm -s run lint
      npm -s run build
    displayName: 'Linter: Device Samples'
  - script: |
      cd digitaltwins/e2e
      npm -s run e2e
    displayName: 'E2E Tests'
    env:
      IOTHUB_CONNECTION_STRING: $(IOTHUB-CONNECTION-STRING)
      AZURE_IOT_PRIVATE_MODEL_REPOSITORY_CONNECTION_STRING: $(AZURE-IOT-PRIVATE-MODEL-REPOSITORY-CONNECTION-STRING)
  - task: PublishTestResults@2
    displayName: 'Publish Test Results | Mocha'
    inputs:
      testResultsFiles: 'e2etests/test-results.*.xml'
      mergeTestResults: true
      testRunTitle: 'E2E Tests - Linux'
    condition: succeededOrFailed()


- phase: Phase_1
  displayName: Windows Build - Node 8

  condition: succeededOrFailed()
  queue:
    name: Hosted
  steps:
  - task: NodeTool@0
    displayName: 'Use Node 8.x'
    inputs:
      versionSpec: '8.x'
  - powershell: |
       runas.exe /savecred /user:administrator
       npm install --global node-gyp
       npm install --global lerna
       npm install
    displayName: 'Install Dependencies'
  - powershell: |
       lerna bootstrap --hoist
       lerna run build
    displayName: 'Bootstrap & Build'
  - script: |
        cd digitaltwins/service
        call npm -s run ci
    displayName: 'Unit Tests: Service'
  - script: |
      cd digitaltwins/model_repository
      call npm -s run ci
    displayName: 'Unit Tests: Model Repository'
  - script: |
      cd digitaltwins/device
      call npm -s run ci
    displayName: 'Unit Tests: Device'
  - script: |
      cd digitaltwins/samples/service
      call npm -s run lint
    displayName: 'Linter: Service Samples'
  - script: |
      cd digitaltwins/samples/model_repository
      call npm -s run lint
    displayName: 'Linter: Model Repo Samples'
  - script: |
      cd digitaltwins/samples/device/typescript
      call npm -s run lint
      call npm -s run build
    displayName: 'Linter: Device Samples'
  - script: |
      cd digitaltwins/e2e
      call npm -s run e2e
    displayName: 'E2E Tests'
    env:
      IOTHUB_CONNECTION_STRING: $(IOTHUB-CONNECTION-STRING)
      AZURE_IOT_PRIVATE_MODEL_REPOSITORY_CONNECTION_STRING: $(AZURE-IOT-PRIVATE-MODEL-REPOSITORY-CONNECTION-STRING)
  - task: PublishTestResults@2
    displayName: 'Publish Test Results | Mocha'
    inputs:
      testResultsFiles: 'e2etests/test-results.*.xml'
      mergeTestResults: true
      testRunTitle: 'E2E Tests - Windows'
    condition: succeededOrFailed()
